#!/bin/bash

echo "üß† Running AI code review before commit..."

exec < /dev/tty

# === Skip first commit

if ! git rev-parse --verify HEAD >/dev/null 2>&1; then

  echo "‚öôÔ∏è First commit detected ‚Äî skipping AI review."

  exit 0

fi

# === Check if backend API is running (port 3001)

if ! curl --silent --fail http://localhost:3001 >/dev/null 2>&1; then

  echo "‚ö†Ô∏è AI review service not running ‚Äî skipping review."

  exit 0

fi

# === Choose review type

echo ""

echo "üìã Select review mode:"

echo "1Ô∏è‚É£  Incremental (new/modified lines only)"

echo "2Ô∏è‚É£  Full file review"

echo "3Ô∏è‚É£  Deleted code review"

read -p "Enter your choice (1/2/3): " mode

case "$mode" in

  1)

    echo "üîç Incremental review selected (default)."

    FILES=$(git diff --cached --name-only --diff-filter=AM)

    DIFF=$(git diff --cached --diff-filter=AM)

    ;;

  2)

    echo "üìÑ Full file review selected."

    FILES=$(git diff --cached --name-only --diff-filter=AM)

    DIFF=""

    for FILE in $FILES; do

      echo "‚¨áÔ∏è Reading full file: $FILE"

      CONTENT=$(cat "$FILE")

      DIFF+="\n\n# FILE: $FILE\n$CONTENT"

    done

    ;;

  3)

    echo "üóë Deleted code review selected."

    FILES=$(git diff --cached --name-only --diff-filter=D)

    DIFF=$(git diff --cached --diff-filter=D)

    ;;

  *)

    echo "‚öôÔ∏è Invalid choice. Defaulting to incremental review."

    FILES=$(git diff --cached --name-only --diff-filter=AM)

    DIFF=$(git diff --cached --diff-filter=AM)

    ;;

esac

if [ -z "$FILES" ]; then

  echo "‚öôÔ∏è No files staged for commit."

  exit 0

fi

# === Send code diff to AI review backend

REVIEW=$(echo "$DIFF" | jq -Rs '{ code: . }' | \

  curl -s -X POST http://localhost:3001/api/review/commit \

  -H "Content-Type: application/json" \

  -d @-)

STATUS=$(echo "$REVIEW" | jq -r '.status')

SUMMARY=$(echo "$REVIEW" | jq -r '.summary')

# === If AI approves

if [ "$STATUS" = "ok" ]; then

  echo "‚úÖ AI review passed. Commit allowed."

  exit 0

fi

# === Otherwise, block and show summary

echo "üö´ Commit blocked: $SUMMARY"

# === Effort estimation before prompt

EFFORT=$(jq -n --arg summary "$SUMMARY" '{ summary: $summary }' | \

  curl -s -X POST http://localhost:3001/api/review/effort \

  -H "Content-Type: application/json" \

  -d @-)

ESTIMATE=$(echo "$EFFORT" | jq -r '.estimate')

echo "üïí Estimated effort: $ESTIMATE"

# === Main decision loop

while true; do

  read -p "üí¨ Respond (r), override (o), auto-fix (f), or cancel (c)? " choice

  case "$choice" in

    f)

      echo "üõ† Generating AI auto-fix for staged files..."

      for FILE in $FILES; do

        echo "üîß Fixing file: $FILE"

        FILE_CONTENT=$(cat "$FILE")

        FIX=$(jq -n --arg code "$FILE_CONTENT" '{ code: $code }' | \

          curl -s -X POST http://localhost:3001/api/review/fix \

          -H "Content-Type: application/json" \

          -d @-)

        FIXED_CODE=$(echo "$FIX" | jq -r '.fixed_code')

        if [ -n "$FIXED_CODE" ] && [ "$FIXED_CODE" != "null" ]; then

          echo "$FIXED_CODE" > "$FILE"

          git add "$FILE"

          echo "Applied fix directly to $FILE"

        else

          echo "‚ö†Ô∏è No fix returned for $FILE"

        fi

      done

      echo "All fixes applied. Commit allowed."

      exit 0

      ;;

    r)

      read -p "Your reply: " reply

      DISCUSSION=$(jq -n --arg issue "$SUMMARY" --arg dev "$reply" \

        '{ issue: $issue, developer_response: $dev }' | \

        curl -s -X POST http://localhost:3001/api/review/discussion \

        -H "Content-Type: application/json" \

        -d @-)

      D_STATUS=$(echo "$DISCUSSION" | jq -r '.status')

      D_SUMMARY=$(echo "$DISCUSSION" | jq -r '.summary')

      echo "ü§ñ AI: $D_SUMMARY"

      if [ "$D_STATUS" = "ok" ]; then

        echo "‚úÖ AI accepted your explanation. Commit allowed."

        exit 0

      else

        echo "üö´ Still rejected by AI reviewer."

        read -p "üòê Override and commit anyway? (y/n) " override

        if [ "$override" = "y" ]; then

          echo "‚ö†Ô∏è Manual override ‚Äî forcing commit."

          exit 0

        else

          echo "‚ùå Commit cancelled."

          exit 1

        fi

      fi

      ;;

    o)

      echo "‚ö†Ô∏è Manual override ‚Äî forcing commit."

      exit 0

      ;;

    c)

      echo "‚ùå Commit cancelled."

      exit 1

      ;;

    *)

      echo "‚ùå Invalid choice. Type r, o, f, or c."

      ;;

  esac

done

